{% extends 'auth_templates/index.html' %}
{% load static %}
{% block content %}

<style>
    :root {
        --primary-blue: #214888;
        --secondary-pink: #D54395;
        --accent-purple: #8B5FBF;
        --light-purple: #F3EBFF;
        --soft-yellow: #FFD700;
        --coral: #FF6B6B;
        --light-bg: #F8F6FF;
        --white: #FFFFFF;
        --text-dark: #453F4E;
        --text-light: #6B7280;
        --success: #10B981;
        --error: #EF4444;
        --border-color: #E5E7EB;
        --border-radius: 12px;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .card-content {
        padding: 2rem;
    }

    .form-container {
        position: relative;
    }

    .form-sections {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    .form-section {
        background: var(--light-bg);
        padding: 1.5rem;
        border-radius: var(--border-radius);
        border: 1px solid var(--border-color);
    }

    .section-title {
        color: var(--primary-blue);
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0 0 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid var(--primary-blue);
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem;
    }

    .form-group {
        position: relative;
        margin-bottom: 0;
    }

    .form-label {
        display: block;
        color: var(--text-dark);
        font-weight: 500;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }

    .required-field::after {
        content: '*';
        color: var(--error);
        margin-left: 0.25rem;
    }

    .form-input {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.875rem;
        font-family: inherit;
        transition: all 0.3s ease;
        background: var(--white);
        box-sizing: border-box;
    }

    .form-input:focus {
        outline: none;
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 3px rgba(33, 72, 136, 0.1);
        transform: translateY(-1px);
    }

    .form-input.error {
        border-color: var(--error);
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        background-color: rgba(239, 68, 68, 0.05);
    }

    .form-input.success {
        border-color: var(--success);
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    textarea.form-input {
        resize: vertical;
        min-height: 100px;
    }

    select.form-input {
        cursor: pointer;
    }

    input[type="file"].form-input {
        padding: 0.5rem;
        border-style: dashed;
    }

    .error-message {
        color: var(--error);
        font-size: 0.75rem;
        margin-top: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        background: rgba(239, 68, 68, 0.1);
        padding: 0.5rem;
        border-radius: 4px;
        border-left: 3px solid var(--error);
    }

    .error-message:empty {
        display: none;
    }

    .submit-section {
        background: var(--light-bg);
        padding: 2rem;
        border-radius: var(--border-radius);
        border: 1px solid var(--border-color);
        text-align: center;
        margin-top: 2rem;
    }

    .submit-button {
        background: linear-gradient(135deg, var(--primary-blue) 0%, var(--accent-purple) 100%);
        color: var(--white);
        border: none;
        padding: 1rem 2.5rem;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        font-family: inherit;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        min-width: 200px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .submit-button::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        transition: all 0.6s ease;
        transform: translate(-50%, -50%);
    }

    .submit-button:hover::before {
        width: 300px;
        height: 300px;
    }

    .submit-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(33, 72, 136, 0.3);
    }

    .submit-button:active {
        transform: translateY(0);
    }

    .submit-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .submit-button span {
        position: relative;
        z-index: 2;
    }

    .loading-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: var(--white);
        animation: spin 1s ease-in-out infinite;
        display: none;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .alert {
        padding: 1rem 1.5rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 500;
    }

    .alert-success {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
        border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .alert-error {
        background: rgba(239, 68, 68, 0.1);
        color: var(--error);
        border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .progress-bar {
        width: 100%;
        height: 4px;
        background: var(--border-color);
        border-radius: 2px;
        margin-bottom: 1rem;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(135deg, var(--primary-blue) 0%, var(--accent-purple) 100%);
        width: 0%;
        transition: width 0.3s ease;
    }

    .salary-summary {
        background: var(--white);
        padding: 1rem;
        border-radius: 8px;
        border: 2px solid var(--primary-blue);
        margin-top: 1rem;
    }

    .salary-summary h5 {
        color: var(--primary-blue);
        margin: 0 0 0.5rem 0;
        font-size: 1rem;
    }

    .salary-line {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--border-color);
    }

    .salary-line:last-child {
        border-bottom: none;
        font-weight: 600;
        font-size: 1.1rem;
        color: var(--primary-blue);
        border-top: 2px solid var(--primary-blue);
        padding-top: 0.75rem;
        margin-top: 0.25rem;
    }

    @media (max-width: 768px) {
        .form-grid {
            grid-template-columns: 1fr;
        }
        
        .students-container {
            padding: 1rem 0.5rem;
        }
        
        .card-content {
            padding: 1.5rem;
        }
        
        .form-section {
            padding: 1rem;
        }
        
        .card-header {
            padding: 1rem;
        }
        
        .card-header h3 {
            font-size: 1.25rem;
        }
        
        .submit-section {
            padding: 1.5rem;
        }
        
        .submit-button {
            width: 100%;
            padding: 1rem;
        }

        .breadcrumb-link span {
            display: none;
        }
    }

    .fade-in {
        animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .field-valid {
        border-color: var(--success) !important;
    }

    .field-invalid {
        border-color: var(--error) !important;
    }
</style>

<!-- Fixed Breadcrumbs -->
<div class="breadcrumb-container">
    <nav aria-label="breadcrumb" class="custom-breadcrumb">
        <div class="breadcrumb-wrapper">
            <ol class="breadcrumb-list">
                <li class="breadcrumb-item">
                    <a href="{% url 'index' %}" class="breadcrumb-link">
                        <i class="fas fa-home"></i>
                        <span>Home</span>
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{% url 'teacher_list' %}" class="breadcrumb-link">
                        <i class="fas fa-chalkboard-teacher"></i>
                        <span>All Teachers</span>
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    <i class="fas fa-user-plus"></i>
                    <span>{% if teacher %}Edit Teacher{% else %}Add Teacher{% endif %}</span>
                </li>
            </ol>
        </div>
    </nav>
</div>

<div class="students-container">
    <div class="dashboard-card-1 fade-in">
        <div class="card-header">
            <h3>
                <i class="fas fa-{% if teacher %}edit{% else %}user-plus{% endif %}"></i> 
                {% if teacher %}Edit {{ teacher.full_name }}{% else %}Teacher/Staff Registration Form{% endif %}
            </h3>
        </div>

        <div class="card-content">
            <!-- Progress Bar -->
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <!-- Alert Messages -->
            <div id="alertContainer"></div>

            <form id="teacherForm" enctype="multipart/form-data" method="post" novalidate>
                {% csrf_token %}
                
                <div class="form-sections">
                    <!-- Personal Information Section -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-user"></i>
                            Personal Information
                        </h4>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="id_first_name" class="form-label required-field">First Name</label>
                                {{ form.first_name }}
                                <div class="error-message" id="error_first_name"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_last_name" class="form-label required-field">Last Name</label>
                                {{ form.last_name }}
                                <div class="error-message" id="error_last_name"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_gender" class="form-label required-field">Gender</label>
                                {{ form.gender }}
                                <div class="error-message" id="error_gender"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_date_of_birth" class="form-label">Date of Birth</label>
                                {{ form.date_of_birth }}
                                <div class="error-message" id="error_date_of_birth"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_nationality" class="form-label required-field">Nationality</label>
                                {{ form.nationality }}
                                <div class="error-message" id="error_nationality"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_religion" class="form-label">Religion</label>
                                {{ form.religion }}
                                <div class="error-message" id="error_religion"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_emirates_id" class="form-label">Emirates ID</label>
                                {{ form.emirates_id }}
                                <div class="error-message" id="error_emirates_id"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_passport_number" class="form-label">Passport Number</label>
                                {{ form.passport_number }}
                                <div class="error-message" id="error_passport_number"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_photo" class="form-label">Photo</label>
                                {{ form.photo }}
                                <div class="error-message" id="error_photo"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Contact Information Section -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-address-book"></i>
                            Contact & Address Information
                        </h4>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="id_email" class="form-label required-field">Email Address</label>
                                {{ form.email }}
                                <div class="error-message" id="error_email"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_phone_number" class="form-label required-field">Phone Number</label>
                                {{ form.phone_number }}
                                <div class="error-message" id="error_phone_number"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_alternative_phone" class="form-label">Alternative Phone</label>
                                {{ form.alternative_phone }}
                                <div class="error-message" id="error_alternative_phone"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_full_address" class="form-label required-field">Full Address</label>
                                {{ form.full_address }}
                                <div class="error-message" id="error_full_address"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_city" class="form-label required-field">City</label>
                                {{ form.city }}
                                <div class="error-message" id="error_city"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_po_box" class="form-label">PO Box</label>
                                {{ form.po_box }}
                                <div class="error-message" id="error_po_box"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Employment Details Section -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-briefcase"></i>
                            Employment Details
                        </h4>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="id_position" class="form-label required-field">Position</label>
                                {{ form.position }}
                                <div class="error-message" id="error_position"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_start_date" class="form-label required-field">Start Date</label>
                                {{ form.start_date }}
                                <div class="error-message" id="error_start_date"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_end_date" class="form-label">End Date (if applicable)</label>
                                {{ form.end_date }}
                                <div class="error-message" id="error_end_date"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_reporting_to" class="form-label">Reporting To</label>
                                {{ form.reporting_to }}
                                <div class="error-message" id="error_reporting_to"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_work_location" class="form-label">Work Location</label>
                                {{ form.work_location }}
                                <div class="error-message" id="error_work_location"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_working_hours_start" class="form-label">Working Hours Start</label>
                                {{ form.working_hours_start }}
                                <div class="error-message" id="error_working_hours_start"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_working_hours_end" class="form-label">Working Hours End</label>
                                {{ form.working_hours_end }}
                                <div class="error-message" id="error_working_hours_end"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_working_days" class="form-label">Working Days</label>
                                {{ form.working_days }}
                                <div class="error-message" id="error_working_days"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_probation_period_months" class="form-label required-field">Probation Period (Months)</label>
                                {{ form.probation_period_months }}
                                <div class="error-message" id="error_probation_period_months"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_annual_leave_days" class="form-label required-field">Annual Leave Days</label>
                                {{ form.annual_leave_days }}
                                <div class="error-message" id="error_annual_leave_days"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Salary Information Section -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-money-bill-wave"></i>
                            Salary Information
                        </h4>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="id_basic_salary" class="form-label required-field">Basic Salary (AED)</label>
                                {{ form.basic_salary }}
                                <div class="error-message" id="error_basic_salary"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_accommodation_allowance" class="form-label">Accommodation Allowance (AED)</label>
                                {{ form.accommodation_allowance }}
                                <div class="error-message" id="error_accommodation_allowance"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_transportation_allowance" class="form-label">Transportation Allowance (AED)</label>
                                {{ form.transportation_allowance }}
                                <div class="error-message" id="error_transportation_allowance"></div>
                            </div>
                        </div>
                        
                        <div class="salary-summary" id="salarySummary" style="display: none;">
                            <h5><i class="fas fa-calculator"></i> Salary Summary</h5>
                            <div class="salary-line">
                                <span>Basic Salary:</span>
                                <span id="displayBasic">AED 0.00</span>
                            </div>
                            <div class="salary-line">
                                <span>Accommodation Allowance:</span>
                                <span id="displayAccommodation">AED 0.00</span>
                            </div>
                            <div class="salary-line">
                                <span>Transportation Allowance:</span>
                                <span id="displayTransportation">AED 0.00</span>
                            </div>
                            <div class="salary-line">
                                <span>Total Salary:</span>
                                <span id="displayTotal">AED 0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Qualifications & Experience Section -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-graduation-cap"></i>
                            Qualifications & Experience
                        </h4>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="id_highest_qualification" class="form-label required-field">Highest Qualification</label>
                                {{ form.highest_qualification }}
                                <div class="error-message" id="error_highest_qualification"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_years_of_experience" class="form-label required-field">Years of Experience</label>
                                {{ form.years_of_experience }}
                                <div class="error-message" id="error_years_of_experience"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_certifications" class="form-label">Certifications</label>
                                {{ form.certifications }}
                                <div class="error-message" id="error_certifications"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_languages_spoken" class="form-label">Languages Spoken</label>
                                {{ form.languages_spoken }}
                                <div class="error-message" id="error_languages_spoken"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Documents Section -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-file-alt"></i>
                            Documents & Certificates
                        </h4>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="id_cv_document" class="form-label">CV/Resume</label>
                                {{ form.cv_document }}
                                <div class="error-message" id="error_cv_document"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_qualification_certificates" class="form-label">Qualification Certificates</label>
                                {{ form.qualification_certificates }}
                                <div class="error-message" id="error_qualification_certificates"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_emirates_id_copy" class="form-label">Emirates ID Copy</label>
                                {{ form.emirates_id_copy }}
                                <div class="error-message" id="error_emirates_id_copy"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_passport_copy" class="form-label">Passport Copy</label>
                                {{ form.passport_copy }}
                                <div class="error-message" id="error_passport_copy"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Emergency Contact Section -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-exclamation-triangle"></i>
                            Emergency Contact
                        </h4>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="id_emergency_contact_name" class="form-label required-field">Contact Name</label>
                                {{ form.emergency_contact_name }}
                                <div class="error-message" id="error_emergency_contact_name"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_emergency_contact_relationship" class="form-label required-field">Relationship</label>
                                {{ form.emergency_contact_relationship }}
                                <div class="error-message" id="error_emergency_contact_relationship"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_emergency_contact_phone" class="form-label required-field">Contact Phone</label>
                                {{ form.emergency_contact_phone }}
                                <div class="error-message" id="error_emergency_contact_phone"></div>
                            </div>
                        </div>
                    </div>

                    <!-- References Section -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-user-check"></i>
                            Professional References
                        </h4>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="id_reference_1_name" class="form-label">Reference 1 Name</label>
                                {{ form.reference_1_name }}
                                <div class="error-message" id="error_reference_1_name"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_reference_1_contact" class="form-label">Reference 1 Contact</label>
                                {{ form.reference_1_contact }}
                                <div class="error-message" id="error_reference_1_contact"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_reference_2_name" class="form-label">Reference 2 Name</label>
                                {{ form.reference_2_name }}
                                <div class="error-message" id="error_reference_2_name"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_reference_2_contact" class="form-label">Reference 2 Contact</label>
                                {{ form.reference_2_contact }}
                                <div class="error-message" id="error_reference_2_contact"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Status & Contract Section -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-info-circle"></i>
                            Status & Contract Information
                        </h4>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="id_status" class="form-label">Employment Status</label>
                                {{ form.status }}
                                <div class="error-message" id="error_status"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_is_active" class="form-label">
                                    {{ form.is_active }}
                                    Active
                                </label>
                                <div class="error-message" id="error_is_active"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_offer_accepted" class="form-label">
                                    {{ form.offer_accepted }}
                                    Offer Accepted
                                </label>
                                <div class="error-message" id="error_offer_accepted"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_offer_acceptance_date" class="form-label">Offer Acceptance Date</label>
                                {{ form.offer_acceptance_date }}
                                <div class="error-message" id="error_offer_acceptance_date"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_contract_signed" class="form-label">
                                    {{ form.contract_signed }}
                                    Contract Signed
                                </label>
                                <div class="error-message" id="error_contract_signed"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_contract_signed_date" class="form-label">Contract Signed Date</label>
                                {{ form.contract_signed_date }}
                                <div class="error-message" id="error_contract_signed_date"></div>
                            </div>
                            
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label for="id_notes" class="form-label">Additional Notes</label>
                                {{ form.notes }}
                                <div class="error-message" id="error_notes"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="submit-section">
                    <button type="submit" class="submit-button" id="submitBtn">
                        <div class="loading-spinner" id="loadingSpinner"></div>
                        <span id="submitText">
                            <i class="fas fa-{% if teacher %}save{% else %}user-plus{% endif %}"></i>
                            {% if teacher %}Update Teacher{% else %}Register Teacher{% endif %}
                        </span>
                    </button>
                    <p style="margin-top: 1rem; color: var(--text-light); font-size: 0.875rem;">
                        Please ensure all required fields are filled before submitting.
                    </p>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('teacherForm');
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const alertContainer = document.getElementById('alertContainer');
    const progressFill = document.getElementById('progressFill');
    const salarySummary = document.getElementById('salarySummary');
    
    // Required fields
    const requiredFields = [
        'first_name', 'last_name', 'gender', 'nationality', 'email', 'phone_number',
        'full_address', 'city', 'position', 'start_date', 'basic_salary',
        'probation_period_months', 'annual_leave_days', 'highest_qualification',
        'years_of_experience', 'emergency_contact_name', 'emergency_contact_relationship',
        'emergency_contact_phone'
    ];
    
    // Real-time validation
    function validateField(fieldName, value) {
        const field = document.getElementById(`id_${fieldName}`);
        const errorElement = document.getElementById(`error_${fieldName}`);
        
        if (!field || !errorElement) return true;
        
        field.classList.remove('error', 'success', 'field-valid', 'field-invalid');
        errorElement.textContent = '';
        errorElement.style.display = 'none';
        
        let isValid = true;
        let errorMessage = '';
        
        if (requiredFields.includes(fieldName)) {
            if (!value || value.toString().trim() === '') {
                isValid = false;
                errorMessage = 'This field is required';
            }
        }
        
        if (value && value.toString().trim() !== '') {
            switch (fieldName) {
                case 'first_name':
                case 'last_name':
                    if (value.length < 2) {
                        isValid = false;
                        errorMessage = 'Name must be at least 2 characters long';
                    } else if (!/^[a-zA-Z\s'-]+$/.test(value)) {
                        isValid = false;
                        errorMessage = 'Name can only contain letters, spaces, hyphens and apostrophes';
                    }
                    break;
                    
                case 'email':
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(value)) {
                        isValid = false;
                        errorMessage = 'Please enter a valid email address';
                    }
                    break;
                    
                case 'phone_number':
                case 'alternative_phone':
                case 'emergency_contact_phone':
                    const phoneRegex = /^[\+]?[\d\s\-\(\)]+$/;
                    if (!phoneRegex.test(value) || value.replace(/\D/g, '').length < 7) {
                        isValid = false;
                        errorMessage = 'Please enter a valid phone number (minimum 7 digits)';
                    }
                    break;
                    
                case 'emirates_id':
                    const cleanId = value.replace(/\D/g, '');
                    if (cleanId.length !== 15) {
                        isValid = false;
                        errorMessage = 'Emirates ID must be 15 digits';
                    }
                    break;
                    
                case 'basic_salary':
                case 'accommodation_allowance':
                case 'transportation_allowance':
                    const amount = parseFloat(value);
                    if (isNaN(amount) || amount < 0) {
                        isValid = false;
                        errorMessage = 'Please enter a valid amount';
                    }
                    break;
                    
                case 'years_of_experience':
                    const years = parseInt(value);
                    if (isNaN(years) || years < 0) {
                        isValid = false;
                        errorMessage = 'Please enter a valid number of years';
                    }
                    break;
                    
                case 'probation_period_months':
                    const months = parseInt(value);
                    if (isNaN(months) || months < 1 || months > 12) {
                        isValid = false;
                        errorMessage = 'Probation period must be between 1 and 12 months';
                    }
                    break;
            }
        }
        
        if (!isValid) {
            field.classList.add('error', 'field-invalid');
            errorElement.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${errorMessage}`;
            errorElement.style.display = 'flex';
        } else if (value && value.toString().trim() !== '') {
            field.classList.add('success', 'field-valid');
        }
        
        return isValid;
    }
    
    // Update progress bar
    function updateProgress() {
        let filledRequiredFields = 0;
        let totalRequiredFields = requiredFields.length;
        
        requiredFields.forEach(fieldName => {
            const field = document.getElementById(`id_${fieldName}`);
            if (field && field.value && field.value.trim() !== '') {
                filledRequiredFields++;
            }
        });
        
        const progress = (filledRequiredFields / totalRequiredFields) * 100;
        progressFill.style.width = `${progress}%`;
        
        return progress;
    }
    
    // Calculate total salary
    function calculateSalary() {
        const basic = parseFloat(document.getElementById('id_basic_salary').value) || 0;
        const accommodation = parseFloat(document.getElementById('id_accommodation_allowance').value) || 0;
        const transportation = parseFloat(document.getElementById('id_transportation_allowance').value) || 0;
        
        const total = basic + accommodation + transportation;
        
        if (basic > 0) {
            salarySummary.style.display = 'block';
            document.getElementById('displayBasic').textContent = `AED ${basic.toFixed(2)}`;
            document.getElementById('displayAccommodation').textContent = `AED ${accommodation.toFixed(2)}`;
            document.getElementById('displayTransportation').textContent = `AED ${transportation.toFixed(2)}`;
            document.getElementById('displayTotal').textContent = `AED ${total.toFixed(2)}`;
        } else {
            salarySummary.style.display = 'none';
        }
    }
    
    // Show alert
    function showAlert(message, type = 'error') {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            ${message}
        `;
        
        alertContainer.innerHTML = '';
        alertContainer.appendChild(alert);
        
        if (type === 'success') {
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }
        
        alert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    
    // Add event listeners to all fields
    const allFields = form.querySelectorAll('input, select, textarea');
    allFields.forEach(field => {
        const fieldName = field.id.replace('id_', '');
        
        field.addEventListener('input', function(e) {
            clearTimeout(this.validationTimeout);
            this.validationTimeout = setTimeout(() => {
                validateField(fieldName, this.value);
                updateProgress();
                
                // Update salary calculation
                if (['basic_salary', 'accommodation_allowance', 'transportation_allowance'].includes(fieldName)) {
                    calculateSalary();
                }
            }, 300);
        });
        
        field.addEventListener('blur', function() {
            validateField(fieldName, this.value);
            updateProgress();
        });
        
        field.addEventListener('change', function() {
            validateField(fieldName, this.value);
            updateProgress();
        });
    });
    
    // File validation
    const fileInputs = form.querySelectorAll('input[type="file"]');
    fileInputs.forEach(input => {
        input.addEventListener('change', function() {
            const fieldName = this.id.replace('id_', '');
            const errorElement = document.getElementById(`error_${fieldName}`);
            
            this.classList.remove('error', 'success');
            errorElement.textContent = '';
            errorElement.style.display = 'none';
            
            if (this.files.length > 0) {
                const file = this.files[0];
                let isValid = true;
                let errorMessage = '';
                
                if (file.size > 5 * 1024 * 1024) {
                    isValid = false;
                    errorMessage = 'File size must be less than 5MB';
                }
                
                if (this.id.includes('photo')) {
                    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                    if (!allowedTypes.includes(file.type)) {
                        isValid = false;
                        errorMessage = 'Please select a valid image file';
                    }
                }
                
                if (!isValid) {
                    this.classList.add('error');
                    errorElement.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${errorMessage}`;
                    errorElement.style.display = 'flex';
                    this.value = '';
                } else {
                    this.classList.add('success');
                }
            }
        });
    });
    
    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        submitBtn.disabled = true;
        loadingSpinner.style.display = 'block';
        submitText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        
        alertContainer.innerHTML = '';
        
        let isFormValid = true;
        let firstErrorField = null;
        
        requiredFields.forEach(fieldName => {
            const field = document.getElementById(`id_${fieldName}`);
            if (field) {
                const isValid = validateField(fieldName, field.value);
                if (!isValid && isFormValid) {
                    isFormValid = false;
                    firstErrorField = field;
                }
            }
        });
        
        if (!isFormValid) {
            showAlert('Please fix all errors before submitting the form.', 'error');
            resetSubmitButton();
            if (firstErrorField) {
                firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstErrorField.focus();
            }
            return;
        }
        
        const formData = new FormData(form);
        
        fetch(form.action || window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showAlert('Teacher registered successfully! Redirecting...', 'success');
                progressFill.style.width = '100%';
                
                setTimeout(() => {
                    window.location.href = "{% url 'teacher_list' %}";

                }, 2000);
            } else {
                let hasErrors = false;
                if (data.errors) {
                    Object.keys(data.errors).forEach(fieldName => {
                        const errorElement = document.getElementById(`error_${fieldName}`);
                        const field = document.getElementById(`id_${fieldName}`);
                        
                        if (errorElement && field) {
                            field.classList.add('error');
                            const errorMsg = Array.isArray(data.errors[fieldName]) 
                                ? data.errors[fieldName][0] 
                                : data.errors[fieldName];
                            errorElement.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${errorMsg}`;
                            errorElement.style.display = 'flex';
                            hasErrors = true;
                        }
                    });
                }
                
                if (hasErrors) {
                    showAlert('Please fix the errors below and try again.', 'error');
                } else {
                    showAlert(data.message || 'An error occurred while submitting the form.', 'error');
                }
                resetSubmitButton();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('An unexpected error occurred. Please try again.', 'error');
            resetSubmitButton();
        });
    });
    
    function resetSubmitButton() {
        submitBtn.disabled = false;
        loadingSpinner.style.display = 'none';
        submitText.innerHTML = '<i class="fas fa-{% if teacher %}save{% else %}user-plus{% endif %}"></i> {% if teacher %}Update Teacher{% else %}Register Teacher{% endif %}';
    }
    
    // Initial setup
    updateProgress();
    calculateSalary();
});
</script>

{% endblock %}