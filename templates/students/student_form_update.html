{% extends 'auth_templates/index.html' %}
{% load static %}
{% block content %}

<style>
    :root {
        --primary-blue: #214888;
        --secondary-pink: #D54395;
        --accent-purple: #8B5FBF;
        --light-purple: #F3EBFF;
        --soft-yellow: #FFD700;
        --coral: #FF6B6B;
        --light-bg: #F8F6FF;
        --white: #FFFFFF;
        --text-dark: #453F4E;
        --text-light: #6B7280;
        --success: #10B981;
        --error: #EF4444;
        --border-color: #E5E7EB;
        --border-radius: 12px;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }


    .card-header {
        /* background: linear-gradient(135deg, var(--primary-blue) 0%, var(--accent-purple) 100%);
        color: var(--white); */
        padding: 1.5rem 2rem;
        border-radius: var(--border-radius) var(--border-radius) 0 0;
    }

    .card-header h3 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .card-content {
        padding: 2rem;
    }

    .form-container {
        position: relative;
    }

    /* Single column layout for better flow */
    .form-sections {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    .form-section {
        background: var(--light-bg);
        padding: 1.5rem;
        border-radius: var(--border-radius);
        border: 1px solid var(--border-color);
    }

    .section-title {
        color: var(--primary-blue);
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0 0 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid var(--primary-blue);
    }

    /* Grid layout within each section for better organization */
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem;
    }

    .form-group {
        position: relative;
        margin-bottom: 0;
    }

    .form-label {
        display: block;
        color: var(--text-dark);
        font-weight: 500;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }

    .required-field::after {
        content: '*';
        color: var(--error);
        margin-left: 0.25rem;
    }

    .form-input {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.875rem;
        font-family: inherit;
        transition: all 0.3s ease;
        background: var(--white);
        box-sizing: border-box;
    }

    .form-input:focus {
        outline: none;
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 3px rgba(33, 72, 136, 0.1);
        transform: translateY(-1px);
    }

    .form-input.error {
        border-color: var(--error);
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        background-color: rgba(239, 68, 68, 0.05);
    }

    .form-input.success {
        border-color: var(--success);
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    textarea.form-input {
        resize: vertical;
        min-height: 100px;
    }

    select.form-input {
        cursor: pointer;
    }

    input[type="file"].form-input {
        padding: 0.5rem;
        border-style: dashed;
    }

    .error-message {
        color: var(--error);
        font-size: 0.75rem;
        margin-top: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        background: rgba(239, 68, 68, 0.1);
        padding: 0.5rem;
        border-radius: 4px;
        border-left: 3px solid var(--error);
    }

    .error-message:empty {
        display: none;
    }

    .success-message {
        color: var(--success);
        font-size: 0.75rem;
        margin-top: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        background: rgba(16, 185, 129, 0.1);
        padding: 0.5rem;
        border-radius: 4px;
        border-left: 3px solid var(--success);
    }

    .submit-section {
        background: var(--light-bg);
        padding: 2rem;
        border-radius: var(--border-radius);
        border: 1px solid var(--border-color);
        text-align: center;
        margin-top: 2rem;
    }

    .submit-button {
        background: linear-gradient(135deg, var(--primary-blue) 0%, var(--accent-purple) 100%);
        color: var(--white);
        border: none;
        padding: 1rem 2.5rem;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        font-family: inherit;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        min-width: 200px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .submit-button::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        transition: all 0.6s ease;
        transform: translate(-50%, -50%);
    }

    .submit-button:hover::before {
        width: 300px;
        height: 300px;
    }

    .submit-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(33, 72, 136, 0.3);
    }

    .submit-button:active {
        transform: translateY(0);
    }

    .submit-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .submit-button span {
        position: relative;
        z-index: 2;
    }

    .loading-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: var(--white);
        animation: spin 1s ease-in-out infinite;
        display: none;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .alert {
        padding: 1rem 1.5rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 500;
    }

    .alert-success {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
        border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .alert-error {
        background: rgba(239, 68, 68, 0.1);
        color: var(--error);
        border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .progress-bar {
        width: 100%;
        height: 4px;
        background: var(--border-color);
        border-radius: 2px;
        margin-bottom: 1rem;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(135deg, var(--primary-blue) 0%, var(--accent-purple) 100%);
        width: 0%;
        transition: width 0.3s ease;
    }

    

    /* Responsive Design */
    @media (max-width: 768px) {
       
        .form-grid {
            grid-template-columns: 1fr;
        }
        
        .students-container {
            padding: 1rem 0.5rem;
        }
        
        .card-content {
            padding: 1.5rem;
        }
        
        .form-section {
            padding: 1rem;
        }
        
        .card-header {
            padding: 1rem;
        }
        
        .card-header h3 {
            font-size: 1.25rem;
        }
        
        .submit-section {
            padding: 1.5rem;
        }
        
        .submit-button {
            width: 100%;
            padding: 1rem;
        }

        .breadcrumb-link span {
            display: none;
        }
    }

    .fade-in {
        animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Field validation states */
    .field-valid {
        border-color: var(--success) !important;
    }

    .field-invalid {
        border-color: var(--error) !important;
    }

    .validation-icon {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.875rem;
    }

    .validation-icon.success {
        color: var(--success);
    }

    .validation-icon.error {
        color: var(--error);
    }
</style>

<!-- Fixed Breadcrumbs -->
<div class="breadcrumb-container">
    <nav aria-label="breadcrumb" class="custom-breadcrumb">
        <div class="breadcrumb-wrapper">
            <ol class="breadcrumb-list">
                <li class="breadcrumb-item">
                    <a href="{% url 'index' %}" class="breadcrumb-link">
                        <i class="fas fa-home"></i>
                        <span>Home</span>
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{% url 'students' %}" class="breadcrumb-link">
                        <i class="fas fa-users"></i>
                        <span>All Students</span>
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    <i class="fas fa-user-plus"></i>
                    <span>Add Student</span>
                </li>
            </ol>
        </div>
    </nav>
</div>

<div class="students-container">
    <div class="dashboard-card-1 fade-in">
        <div class="card-header">
            <h3><i class="fas fa-user-plus"></i> Student Update Form</h3>
        </div>

        <div class="card-content">
            <!-- Progress Bar -->
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <!-- Alert Messages -->
            <div id="alertContainer"></div>

            <form  enctype="multipart/form-data" method="post" >
                {% csrf_token %}
                
                <div class="form-sections">
                    <!-- Child Information Section -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-child"></i>
                            Child Information
                        </h4>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="id_first_name" class="form-label required-field">First Name</label>
                                {{ form.first_name }}
                                <div class="error-message" id="error_first_name"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_last_name" class="form-label required-field">Last Name</label>
                                {{ form.last_name }}
                                <div class="error-message" id="error_last_name"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_family_name" class="form-label">Family Name</label>
                                {{ form.family_name }}
                                <div class="error-message" id="error_family_name"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_nationality" class="form-label required-field">Nationality</label>
                                {{ form.nationality }}
                                <div class="error-message" id="error_nationality"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_gender" class="form-label required-field">Gender</label>
                                {{ form.gender }}
                                <div class="error-message" id="error_gender"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_date_of_birth" class="form-label required-field">Date of Birth</label>
                                {{ form.date_of_birth }}
                                <div class="error-message" id="error_date_of_birth"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_age_at_enrollment" class="form-label">Age at Enrollment</label>
                                {{ form.age_at_enrollment }}
                                <div class="error-message" id="error_age_at_enrollment"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_religion" class="form-label">Religion</label>
                                {{ form.religion }}
                                <div class="error-message" id="error_religion"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_child_emirates_id" class="form-label">Emirates ID</label>
                                {{ form.child_emirates_id }}
                                <div class="error-message" id="error_child_emirates_id"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_languages_spoken" class="form-label">Languages Spoken</label>
                                {{ form.languages_spoken }}
                                <div class="error-message" id="error_languages_spoken"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_child_photo" class="form-label">Child Photo</label>
                                {{ form.child_photo }}
                                <div class="error-message" id="error_child_photo"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Father Information Section -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-male"></i>
                            Father Information
                        </h4>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="id_father_name" class="form-label required-field">Father's Name</label>
                                {{ form.father_name }}
                                <div class="error-message" id="error_father_name"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_father_nationality" class="form-label required-field">Father's Nationality</label>
                                {{ form.father_nationality }}
                                <div class="error-message" id="error_father_nationality"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_father_place_of_work" class="form-label">Place of Work</label>
                                {{ form.father_place_of_work }}
                                <div class="error-message" id="error_father_place_of_work"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_father_position_held" class="form-label">Position Held</label>
                                {{ form.father_position_held }}
                                <div class="error-message" id="error_father_position_held"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_father_mobile" class="form-label">Mobile Number</label>
                                {{ form.father_mobile }}
                                <div class="error-message" id="error_father_mobile"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_father_work_telephone" class="form-label">Work Telephone</label>
                                {{ form.father_work_telephone }}
                                <div class="error-message" id="error_father_work_telephone"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_father_email" class="form-label">Email Address</label>
                                {{ form.father_email }}
                                <div class="error-message" id="error_father_email"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_father_photo" class="form-label">Father Photo</label>
                                {{ form.father_photo }}
                                <div class="error-message" id="error_father_photo"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Mother Information Section -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-female"></i>
                            Mother Information
                        </h4>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="id_mother_name" class="form-label required-field">Mother's Name</label>
                                {{ form.mother_name }}
                                <div class="error-message" id="error_mother_name"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_mother_nationality" class="form-label required-field">Mother's Nationality</label>
                                {{ form.mother_nationality }}
                                <div class="error-message" id="error_mother_nationality"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_mother_place_of_work" class="form-label">Place of Work</label>
                                {{ form.mother_place_of_work }}
                                <div class="error-message" id="error_mother_place_of_work"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_mother_position_held" class="form-label">Position Held</label>
                                {{ form.mother_position_held }}
                                <div class="error-message" id="error_mother_position_held"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_mother_mobile" class="form-label">Mobile Number</label>
                                {{ form.mother_mobile }}
                                <div class="error-message" id="error_mother_mobile"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_mother_work_telephone" class="form-label">Work Telephone</label>
                                {{ form.mother_work_telephone }}
                                <div class="error-message" id="error_mother_work_telephone"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_mother_email" class="form-label">Email Address</label>
                                {{ form.mother_email }}
                                <div class="error-message" id="error_mother_email"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_mother_photo" class="form-label">Mother Photo</label>
                                {{ form.mother_photo }}
                                <div class="error-message" id="error_mother_photo"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Contact & Address Information -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-address-book"></i>
                            Contact & Address Information
                        </h4>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="id_siblings_info" class="form-label">Siblings Information</label>
                                {{ form.siblings_info }}
                                <div class="error-message" id="error_siblings_info"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_home_telephone" class="form-label">Home Telephone</label>
                                {{ form.home_telephone }}
                                <div class="error-message" id="error_home_telephone"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_full_home_address" class="form-label required-field">Full Home Address</label>
                                {{ form.full_home_address }}
                                <div class="error-message" id="error_full_home_address"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_po_box_number" class="form-label">PO Box Number</label>
                                {{ form.po_box_number }}
                                <div class="error-message" id="error_po_box_number"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_city" class="form-label required-field">City</label>
                                {{ form.city }}
                                <div class="error-message" id="error_city"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_email" class="form-label">Primary Email</label>
                                {{ form.email }}
                                <div class="error-message" id="error_email"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_phone_number" class="form-label">Primary Phone Number</label>
                                {{ form.phone_number }}
                                <div class="error-message" id="error_phone_number"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Emergency Contacts -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-exclamation-triangle"></i>
                            Emergency Contacts
                        </h4>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="id_first_contact_person" class="form-label required-field">First Contact Person</label>
                                {{ form.first_contact_person }}
                                <div class="error-message" id="error_first_contact_person"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_first_contact_relationship" class="form-label required-field">Relationship</label>
                                {{ form.first_contact_relationship }}
                                <div class="error-message" id="error_first_contact_relationship"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_first_contact_telephone" class="form-label required-field">Telephone</label>
                                {{ form.first_contact_telephone }}
                                <div class="error-message" id="error_first_contact_telephone"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_second_contact_person" class="form-label">Second Contact Person</label>
                                {{ form.second_contact_person }}
                                <div class="error-message" id="error_second_contact_person"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_second_contact_relationship" class="form-label">Relationship</label>
                                {{ form.second_contact_relationship }}
                                <div class="error-message" id="error_second_contact_relationship"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_second_contact_telephone" class="form-label">Telephone</label>
                                {{ form.second_contact_telephone }}
                                <div class="error-message" id="error_second_contact_telephone"></div>
                            </div>
                        </div>
                    </div>

                    <!-- School Information -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-school"></i>
                            School Information
                        </h4>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="id_term_to_begin" class="form-label required-field">Term to Begin</label>
                                {{ form.term_to_begin }}
                                <div class="error-message" id="error_term_to_begin"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_days_per_week" class="form-label required-field">Days per Week</label>
                                {{ form.days_per_week }}
                                <div class="error-message" id="error_days_per_week"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_hours_required" class="form-label">Hours Required</label>
                                {{ form.hours_required }}
                                <div class="error-message" id="error_hours_required"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_year_of_admission" class="form-label required-field">Year of Admission</label>
                                {{ form.year_of_admission }}
                                <div class="error-message" id="error_year_of_admission"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_date_start" class="form-label">Start Date</label>
                                {{ form.date_start }}
                                <div class="error-message" id="error_date_start"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_date_end" class="form-label">End Date</label>
                                {{ form.date_end }}
                                <div class="error-message" id="error_date_end"></div>
                            </div>

                            <div class="form-group">
                                <label for="id_class_room" class="form-label">Class room</label>
                                {{ form.class_room }}
                                <div class="error-message" id="error_class_room"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="id_parent_signature_date" class="form-label">Parent Signature Date</label>
                                {{ form.parent_signature_date }}
                                <div class="error-message" id="error_parent_signature_date"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="submit-section">
                    <button type="submit" class="submit-button" id="submitBtn">
                        <div class="loading-spinner" id="loadingSpinner"></div>
                        <span id="submitText">
                            <i class="fas fa-user-plus"></i>
                            Update Student
                        </span>
                    </button>
                    <p style="margin-top: 1rem; color: var(--text-light); font-size: 0.875rem;">
                        Please ensure all required fields are filled before submitting.
                    </p>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('studentForm');
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const alertContainer = document.getElementById('alertContainer');
    const progressFill = document.getElementById('progressFill');
    
    // Form validation and progress tracking
    const requiredFields = [
    'first_name', 'last_name', 'nationality', 'gender', 'date_of_birth',
    'father_name', 'father_nationality', 'mother_name', 'mother_nationality',
    'full_home_address', 'city', 'first_contact_person', 'first_contact_relationship',
    'first_contact_telephone', 'days_per_week', 'year_of_admission', 'term_to_begin','class_room'
];
    
    // Real-time validation function
    function validateField(fieldName, value) {
        const field = document.getElementById(`id_${fieldName}`);
        const errorElement = document.getElementById(`error_${fieldName}`);
        
        if (!field || !errorElement) return true;
        
        // Clear previous states
        field.classList.remove('error', 'success', 'field-valid', 'field-invalid');
        errorElement.textContent = '';
        errorElement.style.display = 'none';
        
        let isValid = true;
        let errorMessage = '';
        
        // Check if required field is empty
        if (requiredFields.includes(fieldName)) {
            if (!value || value.toString().trim() === '') {
                isValid = false;
                errorMessage = 'This field is required';
            }
        }
        
        // Specific field validations
        if (value && value.toString().trim() !== '') {
            switch (fieldName) {
                case 'first_name':
                case 'last_name':
                case 'father_name':
                case 'mother_name':
                    if (value.length < 2) {
                        isValid = false;
                        errorMessage = 'Name must be at least 2 characters long';
                    } else if (!/^[a-zA-Z\s'-]+$/.test(value)) {
                        isValid = false;
                        errorMessage = 'Name can only contain letters, spaces, hyphens and apostrophes';
                    }
                    break;
                    
                case 'father_email':
                case 'mother_email':
                case 'email':
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(value)) {
                        isValid = false;
                        errorMessage = 'Please enter a valid email address';
                    }
                    break;
                    
                case 'father_mobile':
                case 'mother_mobile':
                case 'phone_number':
                case 'home_telephone':
                case 'father_work_telephone':
                case 'mother_work_telephone':
                case 'first_contact_telephone':
                case 'second_contact_telephone':
                    const phoneRegex = /^[\+]?[\d\s\-\(\)]+$/;
                    if (!phoneRegex.test(value) || value.replace(/\D/g, '').length < 7) {
                        isValid = false;
                        errorMessage = 'Please enter a valid phone number (minimum 7 digits)';
                    }
                    break;
                    
                case 'date_of_birth':
                    const birthDate = new Date(value);
                    const today = new Date();
                    if (isNaN(birthDate.getTime())) {
                        isValid = false;
                        errorMessage = 'Please enter a valid date';
                    } else {
                        const age = today.getFullYear() - birthDate.getFullYear();
                        const monthDiff = today.getMonth() - birthDate.getMonth();
                        let actualAge = age;
                        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                            actualAge--;
                        }
                        
                        if (actualAge < 1 || actualAge > 18) {
                            isValid = false;
                            errorMessage = 'Child must be between 1 and 18 years old';
                        }
                    }
                    break;
                    
                case 'age_at_enrollment':
                    const age = parseInt(value);
                    if (isNaN(age) || age < 1 || age > 18) {
                        isValid = false;
                        errorMessage = 'Age must be between 1 and 18';
                    }
                    break;
                    
                case 'year_of_admission':
                    const year = parseInt(value);
                    const currentYear = new Date().getFullYear();
                    if (isNaN(year) || year < currentYear - 1 || year > currentYear + 2) {
                        isValid = false;
                        errorMessage = `Year must be between ${currentYear - 1} and ${currentYear + 2}`;
                    }
                    break;
                    
                case 'date_start':
                case 'date_end':
                case 'parent_signature_date':
                    const date = new Date(value);
                    if (isNaN(date.getTime())) {
                        isValid = false;
                        errorMessage = 'Please enter a valid date';
                    }
                    break;
                    
                case 'child_emirates_id':
                    if (value && !/^\d{15}$/.test(value.replace(/\D/g, ''))) {
                        isValid = false;
                        errorMessage = 'Emirates ID should be 15 digits';
                    }
                    break;
            }
        }
        
        // Apply validation state
        if (!isValid) {
            field.classList.add('error', 'field-invalid');
            errorElement.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${errorMessage}`;
            errorElement.style.display = 'flex';
        } else if (value && value.toString().trim() !== '') {
            field.classList.add('success', 'field-valid');
        }
        
        return isValid;
    }
    
    // Update progress bar
    function updateProgress() {
        let filledRequiredFields = 0;
        let totalRequiredFields = requiredFields.length;
        
        requiredFields.forEach(fieldName => {
            const field = document.getElementById(`id_${fieldName}`);
            if (field && field.value && field.value.trim() !== '') {
                filledRequiredFields++;
            }
        });
        
        const progress = (filledRequiredFields / totalRequiredFields) * 100;
        progressFill.style.width = `${progress}%`;
        
        return progress;
    }
    
    // Show alert message
    function showAlert(message, type = 'error') {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            ${message}
        `;
        
        alertContainer.innerHTML = '';
        alertContainer.appendChild(alert);
        
        // Auto-hide success messages
        if (type === 'success') {
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }
        
        // Scroll to alert
        alert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    
    // Add event listeners to all form fields
    const allFields = form.querySelectorAll('input, select, textarea');
    allFields.forEach(field => {
        const fieldName = field.id.replace('id_', '');
        
        // Real-time validation on input
        field.addEventListener('input', function(e) {
            clearTimeout(this.validationTimeout);
            this.validationTimeout = setTimeout(() => {
                validateField(fieldName, this.value);
                updateProgress();
            }, 300); // Debounce validation
        });
        
        // Validation on blur (when user leaves field)
        field.addEventListener('blur', function() {
            validateField(fieldName, this.value);
            updateProgress();
        });
        
        // Validation on change (for selects and file inputs)
        field.addEventListener('change', function() {
            validateField(fieldName, this.value);
            updateProgress();
        });
    });
    
    // Auto-calculate age from date of birth
    const dobField = document.getElementById('id_date_of_birth');
    const ageField = document.getElementById('id_age_at_enrollment');
    
    if (dobField && ageField) {
        dobField.addEventListener('change', function() {
            if (this.value) {
                const birthDate = new Date(this.value);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                
                if (age >= 1 && age <= 18) {
                    ageField.value = age;
                    validateField('age_at_enrollment', age);
                }
            }
        });
    }
    
    // Set default year of admission
    const yearField = document.getElementById('id_year_of_admission');
    if (yearField && !yearField.value) {
        const currentYear = new Date().getFullYear();
        yearField.value = currentYear;
        validateField('year_of_admission', currentYear);
    }
    
    // File input validation
    const fileInputs = form.querySelectorAll('input[type="file"]');
    fileInputs.forEach(input => {
        input.addEventListener('change', function() {
            const fieldName = this.id.replace('id_', '');
            const errorElement = document.getElementById(`error_${fieldName}`);
            
            this.classList.remove('error', 'success');
            errorElement.textContent = '';
            errorElement.style.display = 'none';
            
            if (this.files.length > 0) {
                const file = this.files[0];
                let isValid = true;
                let errorMessage = '';
                
                // Validate file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    isValid = false;
                    errorMessage = 'File size must be less than 5MB';
                }
                
                // Validate file type for photos
                if (this.id.includes('photo')) {
                    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                    if (!allowedTypes.includes(file.type)) {
                        isValid = false;
                        errorMessage = 'Please select a valid image file (JPEG, PNG, GIF, WEBP)';
                    }
                }
                
                if (!isValid) {
                    this.classList.add('error');
                    errorElement.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${errorMessage}`;
                    errorElement.style.display = 'flex';
                    this.value = '';
                } else {
                    this.classList.add('success');
                }
            }
        });
    });
    
    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Show loading state
        submitBtn.disabled = true;
        loadingSpinner.style.display = 'block';
        submitText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        
        // Clear previous alerts
        alertContainer.innerHTML = '';
        
        // Validate all fields
        let isFormValid = true;
        let firstErrorField = null;
        
        // Validate required fields
        requiredFields.forEach(fieldName => {
            const field = document.getElementById(`id_${fieldName}`);
            if (field) {
                const isValid = validateField(fieldName, field.value);
                if (!isValid && isFormValid) {
                    isFormValid = false;
                    firstErrorField = field;
                }
            }
        });
        
        // Validate all other fields that have values
        allFields.forEach(field => {
            const fieldName = field.id.replace('id_', '');
            if (!requiredFields.includes(fieldName) && field.value) {
                const isValid = validateField(fieldName, field.value);
                if (!isValid && isFormValid) {
                    isFormValid = false;
                    if (!firstErrorField) {
                        firstErrorField = field;
                    }
                }
            }
        });
        
        // Additional custom validations
        const fatherEmail = document.getElementById('id_father_email').value;
        const motherEmail = document.getElementById('id_mother_email').value;
        const primaryEmail = document.getElementById('id_email').value;
        
        if (!fatherEmail && !motherEmail && !primaryEmail) {
            isFormValid = false;
            const emailField = document.getElementById('id_father_email');
            const errorElement = document.getElementById('error_father_email');
            emailField.classList.add('error');
            errorElement.innerHTML = '<i class="fas fa-exclamation-circle"></i> At least one email address must be provided';
            errorElement.style.display = 'flex';
            if (!firstErrorField) {
                firstErrorField = emailField;
            }
        }
        
        if (!isFormValid) {
            showAlert('Please fix all errors before submitting the form.', 'error');
            resetSubmitButton();
            if (firstErrorField) {
                firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstErrorField.focus();
            }
            return;
        }
        
        // Submit form via AJAX
        const formData = new FormData(form);
        
        fetch(form.action || window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showAlert('Student registered successfully! Redirecting...', 'success');
                progressFill.style.width = '100%';
                
                // Redirect after success
                setTimeout(() => {
                    window.location.href = data.redirect_url || '/students/';
                }, 2000);
            } else {
                // Handle form errors
                let hasErrors = false;
                if (data.errors) {
                    Object.keys(data.errors).forEach(fieldName => {
                        const errorElement = document.getElementById(`error_${fieldName}`);
                        const field = document.getElementById(`id_${fieldName}`);
                        
                        if (errorElement && field) {
                            field.classList.add('error');
                            const errorMsg = Array.isArray(data.errors[fieldName]) 
                                ? data.errors[fieldName][0] 
                                : data.errors[fieldName];
                            errorElement.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${errorMsg}`;
                            errorElement.style.display = 'flex';
                            hasErrors = true;
                        }
                    });
                }
                
                if (hasErrors) {
                    showAlert('Please fix the errors below and try again.', 'error');
                } else {
                    showAlert(data.message || 'An error occurred while submitting the form.', 'error');
                }
                resetSubmitButton();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('An unexpected error occurred. Please try again.', 'error');
            resetSubmitButton();
        });
    });
    
    function resetSubmitButton() {
        submitBtn.disabled = false;
        loadingSpinner.style.display = 'none';
        submitText.innerHTML = '<i class="fas fa-user-plus"></i> Register Student';
    }
    
    // Initial setup
    updateProgress();
    
    // Form auto-save (optional - saves to localStorage every 30 seconds)
    setInterval(() => {
        const formData = new FormData(form);
        const formObject = {};
        for (let [key, value] of formData.entries()) {
            if (value && typeof value === 'string') {
                formObject[key] = value;
            }
        }
        try {
            localStorage.setItem('studentFormDraft', JSON.stringify(formObject));
        } catch (e) {
            // Handle localStorage errors silently
        }
    }, 30000);
    
    // Load form draft on page load
    try {
        const savedDraft = localStorage.getItem('studentFormDraft');
        if (savedDraft) {
            const draftData = JSON.parse(savedDraft);
            Object.keys(draftData).forEach(key => {
                const field = document.getElementById(key);
                if (field && field.type !== 'file' && !field.value) {
                    field.value = draftData[key];
                }
            });
            updateProgress();
        }
    } catch (e) {
        // Handle localStorage errors silently
    }
    
    // Clear draft on successful submission
    form.addEventListener('submit', function() {
        try {
            localStorage.removeItem('studentFormDraft');
        } catch (e) {
            // Handle localStorage errors silently
        }
    });
});
</script>

{% endblock %}