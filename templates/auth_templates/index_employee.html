<!DOCTYPE html>
{% load static %}
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="{% static 'img/BB_LOGO_V2.png' %}" type="image/x-icon">
    <title>Blossom ERP - Dashboard</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
  <link href="{% static 'glightbox/glightbox.min.css' %}" rel="stylesheet">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .notification-dropdown-list {
        max-height: 400px;
        overflow-y: auto;
    }

    .notification-dropdown-item {
        padding: 16px;
        border-bottom: 1px solid var(--e-global-color-5d90ead);
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: block;
        color: inherit;
    }

    .notification-dropdown-item:hover {
        background: var(--e-global-color-accent);
    }

    .notification-dropdown-item.unread {
        background: var(--e-global-color-fe7363b);
        border-left: 3px solid var(--e-global-color-secondary);
    }

    .notification-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .notification-item-type {
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        padding: 3px 8px;
        border-radius: 4px;
    }

    .notification-item-type.upcoming {
        background: var(--e-global-color-bea3118);
        color: white;
    }

    .notification-item-type.overdue {
        background: var(--e-global-color-7d1e931);
        color: white;
    }

    .notification-item-time {
        font-size: 11px;
        color: var(--e-global-color-text);
        opacity: 0.6;
    }

    .notification-item-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--e-global-color-primary);
        margin: 0 0 6px 0;
    }

    .notification-item-message {
        font-size: 12px;
        color: var(--e-global-color-text);
        margin: 0;
        line-height: 1.5;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .notification-dropdown-empty {
        padding: 40px 20px;
        text-align: center;
        color: var(--e-global-color-text);
        opacity: 0.6;
    }

    .notification-dropdown-empty i {
        font-size: 48px;
        margin-bottom: 12px;
        display: block;
        color: var(--e-global-color-e1cf4e4);
    }
    </style>

</head>

<body>

    <!-- Universal Page Loader -->
    <div class="page-loader" id="pageLoader">
        <div class="loader-content">
            <div class="logo-spinner">
                <div class="spinner-ring"></div>
                <div class="logo-center">
                    <!-- Use your actual logo -->
                    <img src="{% static 'img/BB_LOGO_V2.png' %}" alt="BB Logo"
                        onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="logo-placeholder" style="display: none;">BB</div>
                </div>
                <div class="butterflies">
                    <div class="butterfly"><i class="fas fa-butterfly"></i></div>
                    <div class="butterfly"><i class="fas fa-butterfly"></i></div>
                    <div class="butterfly"><i class="fas fa-butterfly"></i></div>
                    <div class="butterfly"><i class="fas fa-butterfly"></i></div>
                </div>
            </div>
            <div class="loading-text">Loading...</div>
            <div class="loading-subtitle">Please wait</div>
            <div class="loading-dots">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>
        </div>
    </div>
    <!-- Top Navigation Bar -->
    <!-- ADD THIS TOP BAR BEFORE YOUR EXISTING NAV -->
    <!-- <div class="" style="position: fixed;z-index: 1050 !important;right:10px;top:15px;">
        <button class="nav-toggle-btn" style="color: #D54395;" onclick="toggleMainNav()">
            <i class="fas fa-eye"></i>
        </button>
    </div> -->


    <!-- <nav class="top-nav">
        <div class="nav-container">
            <div class="nav-left">
                <div class="logo" style="background-color: white;padding: 5px; border-radius: 10px;">
                    <div class="logo-icon bg-white">
                        <img src="{% static 'img/BB_LOGO_V1.png' %}" style="max-width: 100px;" alt="">
                    </div>

                </div>
                
                <button class="mobile-nav-toggle" id="mobileToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="nav-menu">
                    <div class="nav-item dropdown">
                        <a href="{% url 'index'%}" class="nav-link">
                            <i class="fas fa-tachometer-alt"></i>
                            Dashboard
                        </a>
                    </div>
                    <div class="nav-item dropdown">
                        <a href="#" class="nav-link dropdown-toggle">
                            <i class="fas fa-users"></i>
                            Students
                            <i class="fas fa-chevron-down"></i>
                        </a>
                        <div class="dropdown-menu">
                            <a href="{% url 'student_create' %}" class="dropdown-item"><i class="fas fa-user-plus"></i> Add Student</a>
                            <a href="{% url 'students' %}" class="dropdown-item"><i class="fas fa-list"></i> All Students</a>
                            <a href="#" class="dropdown-item"><i class="fas fa-search"></i> Search Student</a>
                        </div>
                    </div>
                    <div class="nav-item dropdown">
                        <a href="#" class="nav-link dropdown-toggle">
                            <i class="fas fa-credit-card"></i>
                            Payments
                            <i class="fas fa-chevron-down"></i>
                        </a>
                        <div class="dropdown-menu">
                            <a href="#" class="dropdown-item"><i class="fas fa-dollar-sign"></i> Fee Collection</a>
                            <a href="#" class="dropdown-item"><i class="fas fa-receipt"></i> Generate Receipt</a>
                            <a href="#" class="dropdown-item"><i class="fas fa-exclamation-triangle"></i> Outstanding
                                Fees</a>
                        </div>
                    </div>
                    <div class="nav-item dropdown">
                        <a href="#" class="nav-link dropdown-toggle">
                            <i class="fas fa-chart-bar"></i>
                            Reports
                            <i class="fas fa-chevron-down"></i>
                        </a>
                        <div class="dropdown-menu">
                            <a href="#" class="dropdown-item"><i class="fas fa-file-pdf"></i> Financial Reports</a>
                            <a href="#" class="dropdown-item"><i class="fas fa-users"></i> Student Reports</a>
                            <a href="#" class="dropdown-item"><i class="fas fa-bus"></i> Transport Reports</a>
                        </div>
                    </div>
                    <div class="nav-item dropdown">
                        <a href="#" class="nav-link dropdown-toggle">
                            <i class="fas fa-cog"></i>
                            Settings
                            <i class="fas fa-chevron-down"></i>
                        </a>
                        <div class="dropdown-menu">
                            <a href="#" class="dropdown-item"><i class="fas fa-user-cog"></i> User Management</a>
                            <a href="#" class="dropdown-item"><i class="fas fa-school"></i> School Settings</a>
                            <a href="#" class="dropdown-item"><i class="fas fa-backup"></i> Backup & Restore</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="nav-right">
                <div class="nav-item">
                    <a href="#" class="nav-link notification-link">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge">3</span>
                    </a>
                </div>
                <div class="nav-item dropdown">
                    <a href="#" class="nav-link dropdown-toggle user-menu">
                        {% if user.avatar %}
                        <img src="{{ user.avatar.url }}" alt="User" class="user-avatar">
                        {% else %}
                        <img src="{% static 'img/userplaceholder.png' %}" alt="User" class="user-avatar">
                        {% endif %}
                        <span>{{ user.first_name }}</span>
                        <i class="fas fa-chevron-down"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right">
                        <a href="{% url 'profile' %}" class="dropdown-item"><i class="fas fa-user"></i> Profile</a>
                        <div class="dropdown-divider"></div>
                        <a href="{% url 'signout' %}" class="dropdown-item"><i class="fas fa-sign-out-alt"></i>
                            Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </nav> -->


 <nav class="navbar navbar-expand-lg custom-navbar sticky-top">
    <div class="container-fluid px-4">
        <!-- Logo -->
        <a class="navbar-brand" href="{% url 'index' %}">
            <img src="{% static 'img/BB_LOGO_V1.png' %}" alt="Blossom British"  style="max-width: 100px;">
        </a>

        <!-- Mobile Toggle -->
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false">
            <i class="fas fa-bars text-white"></i>
        </button>

        <!-- Navigation Menu -->
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto ms-4">
                <!-- Dashboard -->
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'index' %}">
                        <i class="fas fa-tachometer-alt"></i>
                        Dashboard
                    </a>
                </li>

                <!-- Students -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-users"></i>
                        Students
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{% url 'student_create' %}">
                            <i class="fas fa-user-plus"></i> Add Student
                        </a></li>
                        <li><a class="dropdown-item" href="{% url 'students' %}">
                            <i class="fas fa-list"></i> All Students
                        </a></li>
                        <!-- <li><a class="dropdown-item" href="#">
                            <i class="fas fa-search"></i> Search Student
                        </a></li> -->
                    </ul>
                </li>

                <!-- Payments -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-credit-card"></i>
                        Payments
                    </a>
                    <ul class="dropdown-menu">
                        <!-- <li>
                            <a class="dropdown-item" href="{% url 'payment_dashboard' %}"><i class="fas fa-tachometer-alt"></i> Payment Dashboard</a>
                        </li> -->
                        <li><a class="dropdown-item" href="{% url 'create_payment' %}">
                            <i class="fas fa-dollar-sign"></i> Fee Collection
                        </a></li>
                        <!-- <li><a class="dropdown-item" href="#">
                            <i class="fas fa-receipt"></i> Generate Receipt
                        </a></li>
                        <li><a class="dropdown-item" href="#">
                            <i class="fas fa-exclamation-triangle"></i> Outstanding Fees
                        </a></li> -->
                    </ul>
                </li>

                <!-- Reports -->
                <!-- <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-briefcase"></i> Finance 

                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{%url 'income'%}">
                            <i class="fas fa-hand-holding-usd"></i> Income

                        </a></li>
                        <li><a class="dropdown-item" href="{%url 'expense' %}">
                           <i class="fas fa-money-bill-wave"></i> Expense

                        </a></li>
                        <li><a class="dropdown-item" href="{%url 'balance_sheet' %}">
                           <i class="fas fa-chart-line"></i> Balance Sheet

                        </a></li>
                    </ul>
                </li> -->

                <!-- Settings -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-cog"></i>
                        Utilities
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{% url 'teacher_list' %}">
                            <i class="fas fa-user-cog"></i> Staff Management
                        </a></li>
                        <li><a class="dropdown-item" href="{% url 'attendance_dashboard' %}">
                            <i class="fas fa-calendar"></i> Attendance Management
                        </a></li>
                         <li><a class="dropdown-item" href="{% url 'salary_dashboard' %}">
                            <i class="fas fa-money-bill-wave"></i> Salary Management
                        </a></li>
                        <li><a class="dropdown-item" href="{% url 'site_setting' %}">
                            <i class="fas fa-school"></i> School Settings
                        </a></li>  
                    </ul>
                </li>

                <!-- <li class="nav-item">
                    <a class="nav-link" href="{% url 'reports_dashboard' %}">
                        <i class="fas fa-chart-bar"></i> Reports    
                    </a>
                </li> -->
            </ul>

            <!-- Right Side Menu -->
            <ul class="navbar-nav ms-auto">
                <!-- Notifications -->
                <li class="nav-item">
                    <a class="nav-link notification-link" href="#">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge">{{ unread_notification_count }}</span>
                    </a>
                </li>

                <!-- User Menu -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle user-menu text-white" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        {% if user.avatar %}
                            <img src="{{ user.avatar.url }}" alt="User" class="user-avatar">
                        {% else %}
                            <img src="{% static 'img/userplaceholder.png' %}" alt="User" class="user-avatar">
                        {% endif %}
                        <span class="user-name">{{ user.username }}</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="{% url 'profile' %}">
                            <i class="fas fa-user"></i> Profile
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="{% url 'signout' %}">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a></li>
                         <li><a class="dropdown-item" href="#">
                            <i class="fas fa-cloud-upload-alt"></i> Backup & Restore
                        </a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

    <!-- Main Content -->
<main class="main-content">
    <div class="dashboard-container">
        {% block content %} <!-- Page Header -->
        <!-- Page Header -->
        <div class="page-header">
            <h1>Dashboard Overview</h1>
            <p>Welcome back! Here's what's happening at Blossom British Kids Center today.</p>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card primary">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                    <h3 id="totalStudents">{{students_count}}</h3>
                    <p>Total Students</p>
                    <span class="stat-change positive" id="studentChange">Loading...</span>
                </div>
            </div>
            <div class="stat-card secondary">
                <div class="stat-icon">
                    <i class="fas fa-chalkboard-teacher"></i>
                </div>
                <div class="stat-content">
                    <h3 id="totalTeachers">{{staff_count}}</h3>
                    <p>Active Staffs</p>
                    <span class="stat-change positive" id="teacherChange">Loading...</span>
                </div>
            </div>
            <!-- <div class="stat-card accent">
                <div class="stat-icon">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="stat-content">
                    <h3 id="totalRevenue">AED {{total_revenue}}</h3>
                    <p>Total Revenue (This Month)</p>
                    <span class="stat-change positive" id="revenueChange">Loading...</span>
                </div>
            </div> -->
            <div class="stat-card warning">
                <div class="stat-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-content">
                    <h3 id="pendingPayments">{{pending_installments}}</h3>
                    <p>Pending Installments</p>
                    <span class="stat-change negative" id="overdueCount">Loading...</span>
                </div>
            </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="dashboard-grid">
            <!-- Revenue & Expense Overview -->
            <!-- <div class="dashboard-card large">
                <div class="card-header">
                    <h3><i class="fas fa-chart-line"></i> Revenue & Expense Trend</h3>
                    <div class="card-actions">
                        <select class="form-select" id="revenuePeriod">
                            <option value="6">Last 6 Months</option>
                            <option value="12">Last Year</option>
                        </select>
                    </div>
                </div>
                <div class="card-content">
                    <div class="chart-container">
                        <canvas id="revenueExpenseChart"></canvas>
                    </div>
                </div>
            </div> -->

            <!-- Student Status Distribution -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h3><i class="fas fa-chart-pie"></i> Student Status</h3>
                </div>
                <div class="card-content">
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="studentStatusChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 2 -->
        <div class="dashboard-grid">
            <!-- Income Forecasting (MANDATORY) -->
            <!-- <div class="dashboard-card large">
                <div class="card-header">
                    <h3><i class="fas fa-chart-area"></i> Next Month Income Forecast</h3>
                    <span class="period-badge" id="forecastMonth">Based on Payment Installments</span>
                </div>
                <div class="card-content">
                    <div class="chart-container">
                        <canvas id="forecastChart"></canvas>
                    </div>
                    <div style="margin-top: 20px; padding: 15px; background: var(--e-global-color-eecedb7); border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <p style="font-size: 14px; opacity: 0.8; margin-bottom: 5px;">Expected Income Next Month</p>
                                <h2 style="color: var(--e-global-color-primary); margin: 0;" id="forecastAmount">AED 0</h2>
                            </div>
                            <div>
                                <p style="font-size: 14px; opacity: 0.8; margin-bottom: 5px;">Expected Installments</p>
                                <h2 style="color: var(--e-global-color-4e9ef99); margin: 0;" id="forecastCount">0</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div> -->

            <!-- Recent Payments -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h3><i class="fas fa-receipt"></i> Recent Payments</h3>
                    <a href="#" class="view-all">View All</a>
                </div>
                <div class="card-content">
                    <div class="activity-list" id="recentPaymentsList">
                        <p style="text-align: center; opacity: 0.6;">Loading payments...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Analytics Row -->
        <div class="dashboard-grid-bottom">
            <!-- Class Distribution -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h3><i class="fas fa-door-open"></i> Class Distribution</h3>
                </div>
                <div class="card-content">
                    <div class="class-distribution" id="classDistribution">
                        <p style="text-align: center; opacity: 0.6;">Loading classes...</p>
                    </div>
                </div>
            </div>

            <!-- Fee Collection Summary -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h3><i class="fas fa-money-bill-wave"></i> Fee Collection Summary</h3>
                    <span class="period-badge">This Month</span>
                </div>
                <div class="card-content">
                    <div class="fee-summary">
                        <div class="fee-item">
                            <div class="fee-label">
                                <span class="fee-dot collected"></span>
                                Collected
                            </div>
                            <div class="fee-amount" id="collectedAmount">AED 0</div>
                            <div class="fee-percentage" id="collectedPercentage">0%</div>
                        </div>
                        <div class="fee-item">
                            <div class="fee-label">
                                <span class="fee-dot pending"></span>
                                Pending
                            </div>
                            <div class="fee-amount" id="pendingAmount">AED 0</div>
                            <div class="fee-percentage" id="pendingPercentage">0%</div>
                        </div>
                        <div class="fee-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="collectionProgress" style="width: 0%"></div>
                            </div>
                        </div>
                        <p class="fee-target" id="targetAmount">Target: AED 0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Teacher Attendance Summary -->
        <div class="dashboard-grid-bottom">
            <div class="dashboard-card">
                <div class="card-header">
                    <h3><i class="fas fa-user-check"></i> Teacher Attendance Today</h3>
                </div>
                <div class="card-content">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <div style="text-align: center; padding: 15px; background: rgba(67, 165, 116, 0.1); border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 700; color: var(--e-global-color-4e9ef99);" id="teachersPresent">0</div>
                            <div style="font-size: 12px; opacity: 0.8;">Present</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: rgba(255, 149, 135, 0.1); border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 700; color: var(--e-global-color-7d1e931);" id="teachersAbsent">0</div>
                            <div style="font-size: 12px; opacity: 0.8;">Absent</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: rgba(255, 184, 4, 0.1); border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 700; color: var(--e-global-color-3a7e2f2);" id="teachersHalfDay">0</div>
                            <div style="font-size: 12px; opacity: 0.8;">Half Day</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="dashboard-card">
                <div class="card-header">
                    <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
                </div>
                <div class="card-content">
                    <div class="quick-actions">
                        <a href="{%url 'student_create'%}" class="action-btn primary">
                            <i class="fas fa-user-plus"></i>
                            <span>Add New Student</span>
                        </a>
                        <a href="{%url 'create_payment'%}" class="action-btn secondary">
                            <i class="fas fa-credit-card"></i>
                            <span>Record Payment</span>
                        </a>
                        
                    </div>
                </div>
            </div>
        </div>
{% endblock %}
    
    </div>
</main>

<script>
// Initialize Charts
let revenueChart, studentStatusChart, forecastChart;

// Fetch Real Dashboard Data from Django API
async function fetchDashboardData() {
    try {
        const response = await fetch('/api/dashboard-data/');
        const data = await response.json();
        
        // Update Student Stats
        document.getElementById('totalStudents').textContent = data.students.total || 0;
        document.getElementById('studentChange').textContent = `${data.students.this_month || 0} this month`;
        
        // Update Teacher Stats
        document.getElementById('totalTeachers').textContent = data.teachers.active || 0;
        document.getElementById('teacherChange').textContent = `${data.teachers.total || 0} total staffs`;
        
        // Update Revenue Stats
        const revenue = data.payments.total_revenue || 0;
        document.getElementById('totalRevenue').textContent = `AED ${revenue.toLocaleString()}`;
        const changeSymbol = data.payments.revenue_change >= 0 ? '+' : '';
        document.getElementById('revenueChange').textContent = `${changeSymbol}${data.payments.revenue_change.toFixed(1)}% vs last month`;
        
        // Update Pending Payments
        document.getElementById('pendingPayments').textContent = data.payments.pending_installments || 0;
        document.getElementById('overdueCount').textContent = `${data.payments.overdue_installments || 0} overdue`;
        
        // Update Teacher Attendance
        document.getElementById('teachersPresent').textContent = data.teachers.attendance_today.present;
        document.getElementById('teachersAbsent').textContent = data.teachers.attendance_today.absent;
        document.getElementById('teachersHalfDay').textContent = data.teachers.attendance_today.half_day;
        
        // Update Fee Collection Summary
        // updateFeeCollectionSummary(data.fee_collection);
        
        // Update Forecast
        updateForecast(data.forecast);
        
        // Update Recent Payments
        updateRecentPayments(data.payments.recent_payments);
        
        // Initialize Charts with real data
        initializeCharts(data);
        
        // Fetch and update class distribution
        fetchClassDistribution();
        
    } catch (error) {
        console.error('Error fetching dashboard data:', error);
    }
}

// Initialize All Charts with Real Data
function initializeCharts(data) {
    // Revenue & Expense Chart
    const revenueCtx = document.getElementById('revenueExpenseChart');
    if (revenueCtx) {
        if (revenueChart) revenueChart.destroy();
        
        revenueChart = new Chart(revenueCtx, {
            type: 'line',
            data: {
                labels: data.trends.labels,
                datasets: [
                    {
                        label: 'Revenue',
                        data: data.trends.revenue,
                        borderColor: '#43A574',
                        backgroundColor: 'rgba(67, 165, 116, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Expenses',
                        data: data.trends.expenses,
                        borderColor: '#FF9587',
                        backgroundColor: 'rgba(255, 149, 135, 0.1)',
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'AED ' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }

    // Student Status Chart
    const statusCtx = document.getElementById('studentStatusChart');
    if (statusCtx && data.students.by_status) {
        if (studentStatusChart) studentStatusChart.destroy();
        
        const labels = data.students.by_status.map(s => s.status.replace('_', ' ').toUpperCase());
        const chartData = data.students.by_status.map(s => s.count);
        const colors = ['#214888', '#FFB804', '#43A574', '#FF9587', '#89C0FF'];
        
        studentStatusChart = new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: chartData,
                    backgroundColor: colors.slice(0, chartData.length),
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                }
            }
        });
    }

    // Forecast Chart (MANDATORY)
    const forecastCtx = document.getElementById('forecastChart');
    if (forecastCtx && data.forecast.by_week) {
        if (forecastChart) forecastChart.destroy();
        
        const weekLabels = data.forecast.by_week.map(w => w.week);
        const weekData = data.forecast.by_week.map(w => w.amount);
        
        forecastChart = new Chart(forecastCtx, {
            type: 'bar',
            data: {
                labels: weekLabels,
                datasets: [{
                    label: 'Expected Collections',
                    data: weekData,
                    backgroundColor: '#214888',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'AED ' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }
}

// Update Fee Collection Summary
function updateFeeCollectionSummary(feeData) {
    const collected = feeData.collected;
    const pending = feeData.pending;
    const total = feeData.total_target;
    const percentage = feeData.percentage;
    
    document.getElementById('collectedAmount').textContent = `AED ${collected.toLocaleString()}`;
    document.getElementById('pendingAmount').textContent = `AED ${pending.toLocaleString()}`;
    document.getElementById('collectedPercentage').textContent = `${Math.round(percentage)}%`;
    document.getElementById('pendingPercentage').textContent = `${Math.round(100 - percentage)}%`;
    document.getElementById('collectionProgress').style.width = `${percentage}%`;
    document.getElementById('targetAmount').textContent = `Target: AED ${total.toLocaleString()}`;
}

// Update Forecast
function updateForecast(forecastData) {
    document.getElementById('forecastAmount').textContent = `AED ${forecastData.next_month_total.toLocaleString()}`;
    document.getElementById('forecastCount').textContent = forecastData.installment_count;
    document.getElementById('forecastMonth').textContent = forecastData.month_name;
}

// Update Recent Payments
function updateRecentPayments(payments) {
    if (!payments || payments.length === 0) {
        document.getElementById('recentPaymentsList').innerHTML = '<p style="text-align: center; opacity: 0.6;">No recent payments</p>';
        return;
    }
    
    const html = payments.map(payment => {
        const date = new Date(payment.payment_date);
        const timeAgo = getTimeAgo(date);
        
        return `
            <div class="activity-item">
                <div class="activity-icon payment">
                    <i class="fas fa-credit-card"></i>
                </div>
                <div class="activity-content">
                    <p><strong>${payment.student_name}</strong> paid AED ${payment.amount.toLocaleString()}</p>
                    <span class="activity-time">${timeAgo} • ${payment.payment_method}</span>
                </div>
            </div>
        `;
    }).join('');
    
    document.getElementById('recentPaymentsList').innerHTML = html;
}

// Fetch Class Distribution
async function fetchClassDistribution() {
    try {
        const response = await fetch('/api/class-distribution/');
        const data = await response.json();
        
        if (!data.classes || data.classes.length === 0) {
            document.getElementById('classDistribution').innerHTML = '<p style="text-align: center; opacity: 0.6;">No classes found</p>';
            return;
        }
        
        const html = data.classes.map(cls => `
            <div class="class-item">
                <div class="class-info">
                    <span class="class-name">${cls.name}</span>
                    <span class="class-count">${cls.students}/${cls.capacity} students</span>
                </div>
                <div class="class-progress">
                    <div class="progress-bar small">
                        <div class="progress-fill primary" style="width: ${cls.percentage}%"></div>
                    </div>
                </div>
            </div>
        `).join('');
        
        document.getElementById('classDistribution').innerHTML = html;
        
    } catch (error) {
        console.error('Error fetching class distribution:', error);
        document.getElementById('classDistribution').innerHTML = '<p style="text-align: center; opacity: 0.6;">Error loading classes</p>';
    }
}

// Helper function to calculate time ago
function getTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 60) {
        return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
    } else if (diffHours < 24) {
        return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
    } else if (diffDays < 30) {
        return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
    } else {
        return date.toLocaleDateString();
    }
}

// Initialize Dashboard on Load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Nursery ERP Dashboard initialized successfully!');
    fetchDashboardData();
});

// Refresh data every 5 minutes
setInterval(fetchDashboardData, 300000);
</script>


    <!-- scripts  -->
      <script src="{% static 'glightbox/glightbox.min.js' %}"></script>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'script/script.js' %}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        class UniversalLoader {
            constructor() {
                this.loader = document.getElementById('pageLoader');
                this.mainContent = document.getElementById('mainContent');
                this.loadingText = document.querySelector('.loading-text');
                this.loadingSubtitle = document.querySelector('.loading-subtitle');
                this.isLoading = true;
                this.minLoadTime = 800; // Minimum loading time in ms
                this.startTime = Date.now();

                this.init();
            }

            init() {
                // Set initial loading message based on page
                this.setLoadingMessage();

                // Start loading process
                this.startLoading();

                // Hide loader when page is fully loaded
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => this.checkComplete());
                    window.addEventListener('load', () => this.checkComplete());
                } else {
                    this.checkComplete();
                }
            }

            setLoadingMessage() {
                const path = window.location.pathname;
                let message = 'Loading...';
                let subtitle = 'Please wait';

                if (path.includes('dashboard')) {
                    message = 'Preparing Dashboard';
                    subtitle = 'Setting up your workspace';
                } else if (path.includes('students')) {
                    message = 'Loading Students';
                    subtitle = 'Fetching student data';
                } else if (path.includes('payments')) {
                    message = 'Loading Payments';
                    subtitle = 'Processing financial data';
                } else if (path.includes('reports')) {
                    message = 'Generating Reports';
                    subtitle = 'Compiling information';
                } else if (path.includes('login')) {
                    message = 'Welcome Back';
                    subtitle = 'Preparing login';
                } else {
                    message = 'Loading Page';
                    subtitle = 'Almost ready';
                }

                this.loadingText.textContent = message;
                this.loadingSubtitle.textContent = subtitle;
            }

            startLoading() {
                // Show loader
                this.loader.classList.remove('hidden');
                this.mainContent.style.opacity = '0';

                // Prevent scroll during loading
                document.body.style.overflow = 'hidden';
            }

            checkComplete() {
                if (!this.isLoading) return;

                const elapsed = Date.now() - this.startTime;
                const remainingTime = Math.max(0, this.minLoadTime - elapsed);

                setTimeout(() => {
                    this.hideLoader();
                }, remainingTime);
            }

            hideLoader() {
                this.isLoading = false;

                // Update loading message
                this.loadingText.textContent = 'Ready!';
                this.loadingSubtitle.textContent = 'Welcome to Blossom British';

                setTimeout(() => {
                    // Hide loader with animation
                    this.loader.classList.add('hidden');
                    this.mainContent.style.opacity = '1';

                    // Re-enable scroll
                    document.body.style.overflow = '';

                    // Remove loader from DOM after animation
                    setTimeout(() => {
                        if (this.loader.parentNode) {
                            this.loader.remove();
                        }
                    }, 500);
                }, 300);
            }

            // Method to show loader programmatically (for AJAX calls)
            show(message = 'Loading...', subtitle = 'Please wait') {
                if (!this.loader.parentNode) {
                    // Re-create loader if it was removed
                    location.reload();
                    return;
                }

                this.loadingText.textContent = message;
                this.loadingSubtitle.textContent = subtitle;
                this.loader.classList.remove('hidden');
                this.mainContent.style.opacity = '0.3';
                document.body.style.overflow = 'hidden';
                this.isLoading = true;
            }

            // Method to hide loader programmatically
            hide() {
                if (!this.isLoading) return;

                setTimeout(() => {
                    this.hideLoader();
                }, 200);
            }
        }

        // Initialize loader
        const universalLoader = new UniversalLoader();

        // Make loader accessible globally for AJAX calls
        window.loader = {
            show: (message, subtitle) => universalLoader.show(message, subtitle),
            hide: () => universalLoader.hide()
        };

        // Auto-show loader for form submissions
        document.addEventListener('submit', function (e) {
            const form = e.target;
            if (form.tagName === 'FORM') {
                window.loader.show('Processing...', 'Submitting your request');
            }
        });

        // Auto-show loader for navigation links (optional)
        document.addEventListener('click', function (e) {
            const link = e.target.closest('a[href]');
            if (link && link.href && !link.href.startsWith('#') && !link.href.startsWith('javascript:') && !link.hasAttribute('download') && !link.target) {
                // Only show for internal navigation
                if (link.href.includes(window.location.origin)) {
                    window.loader.show('Navigating...', 'Loading page');
                }
            }
        });

    </script>
    <script>
        // Force hide loader after 2 seconds (emergency fallback)
        setTimeout(() => {
            const loader = document.getElementById('pageLoader');
            if (loader) {
                loader.classList.add('hidden');
                document.getElementById('mainContent').style.opacity = '1';
                document.body.style.overflow = '';
            }
        }, 2000);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    {% if messages %}
    <script>
        // Custom CSS for Blossom British themed alerts
        const blossomTheme = `
        .swal2-popup {
        background: linear-gradient(135deg, #F8F6FF 0%, #E8DFFF 50%, #F3EBFF 100%) !important;
        border-radius: 20px !important;
        border: 3px solid transparent !important;
        background-clip: padding-box !important;
        box-shadow: 0 15px 35px rgba(33, 72, 136, 0.15), 0 5px 15px rgba(0, 0, 0, 0.08) !important;
        font-family: 'Poppins', sans-serif !important;
        position: relative !important;
        overflow: hidden !important;
        }
        
        .swal2-popup::before {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(45deg, #214888, #D54395, #8B5FBF, #4ECDC4);
        border-radius: 22px;
        z-index: -1;
        animation: borderRotate 3s linear infinite;
        }
        
        @keyframes borderRotate {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
        }
        
        .swal2-title {
        color: #214888 !important;
        font-weight: 600 !important;
        font-size: 20px !important;
        margin-bottom: 15px !important;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
        }
        
        .swal2-icon {
        border: none !important;
        margin: 20px auto 15px !important;
        position: relative !important;
        }
        
        .swal2-icon::before {
        content: '✨';
        position: absolute;
        top: -10px;
        right: -10px;
        font-size: 16px;
        animation: sparkle 2s ease-in-out infinite;
        }
        
        .swal2-icon.swal2-success {
        background: linear-gradient(135deg, #4ECDC4, #FFD700) !important;
        color: white !important;
        }
        
        .swal2-icon.swal2-error {
        background: linear-gradient(135deg, #FF6B6B, #D54395) !important;
        color: white !important;
        }
        
        .swal2-icon.swal2-warning {
        background: linear-gradient(135deg, #FFD700, #FF6B6B) !important;
        color: white !important;
        }
        
        .swal2-icon.swal2-info {
        background: linear-gradient(135deg, #214888, #8B5FBF) !important;
        color: white !important;
        }
        
        .swal2-confirm {
        background: linear-gradient(135deg, #214888 0%, #D54395 100%) !important;
        border: none !important;
        border-radius: 25px !important;
        padding: 12px 30px !important;
        font-weight: 600 !important;
        font-size: 14px !important;
        color: white !important;
        box-shadow: 0 5px 15px rgba(33, 72, 136, 0.3) !important;
        transition: all 0.3s ease !important;
        }
        
        .swal2-confirm:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 8px 25px rgba(33, 72, 136, 0.4) !important;
        }
        
        .swal2-container {
        backdrop-filter: blur(10px) !important;
        background: rgba(248, 246, 255, 0.3) !important;
        }
        
        @keyframes sparkle {
        0%, 100% { opacity: 1; transform: scale(1) rotate(0deg); }
        50% { opacity: 0.7; transform: scale(1.2) rotate(180deg); }
        }
        
        .floating-butterflies {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        overflow: hidden;
        }
        
        .butterfly-float {
        position: absolute;
        color: #D54395;
        font-size: 16px;
        opacity: 0.6;
        animation: butterflyFloat 4s ease-in-out infinite;
        }
        
        .butterfly-float:nth-child(1) {
        top: 20%;
        left: 10%;
        animation-delay: 0s;
        color: #FFD700;
        }
        
        .butterfly-float:nth-child(2) {
        top: 70%;
        right: 15%;
        animation-delay: -2s;
        color: #4ECDC4;
        }
        
        @keyframes butterflyFloat {
        0%, 100% { transform: translateY(0px) translateX(0px) rotate(0deg); }
        25% { transform: translateY(-10px) translateX(5px) rotate(5deg); }
        50% { transform: translateY(-5px) translateX(-8px) rotate(-3deg); }
        75% { transform: translateY(-15px) translateX(3px) rotate(7deg); }
        }
    `;

        // Inject custom styles
        const style = document.createElement('style');
        style.textContent = blossomTheme;
        document.head.appendChild(style);

        '{% for message in messages %}'
        // Add floating butterflies to the alert
        const butterflyHTML = `
        <div class="floating-butterflies">
            <div class="butterfly-float">🦋</div>
            <div class="butterfly-float">🦋</div>
        </div>
        `;

        Swal.fire({
            icon: "{% if message.tags == 'success' %}success{% elif message.tags == 'error' %}error{% elif message.tags == 'warning' %}warning{% else %}info{% endif %}",
            title: "{{ message|escapejs }}",
            html: butterflyHTML,
            showConfirmButton: true,
            confirmButtonText: '✨ Got it!',
            timer: 4000,
            timerProgressBar: true,
            allowEscapeKey: true,
            allowOutsideClick: true,
            showClass: {
                popup: 'animate__animated animate__bounceIn animate__faster'
            },
            hideClass: {
                popup: 'animate__animated animate__fadeOutUp animate__faster'
            },
            customClass: {
                popup: 'blossom-alert',
                title: 'blossom-title',
                confirmButton: 'blossom-button'
            }
        });
        '{% endfor %}'
    </script>
    {% endif %}
<script>
    function showNotifications() {
    // Create notification dropdown
    const notificationDropdown = document.createElement('div');
    notificationDropdown.className = 'notification-dropdown';
    notificationDropdown.innerHTML = `
        <div class="notification-header">
            <h4>Notifications</h4>
            <button class="mark-all-read">Mark all as read</button>
        </div>
        <div class="notification-list">
            {% if recent_notifications %}
                {% for notification in recent_notifications %}
                <a href="{% url 'student_detail' notification.student.pk %}" 
                   class="notification-dropdown-item {% if not notification.is_read %}unread{% endif %}"
                   onclick="markNotificationRead(event, {{ notification.id }}, '{% url 'student_detail' notification.student.pk %}')">
                    <div class="notification-item-header">
                        <span class="notification-item-type {{ notification.notification_type }}">
                            {{ notification.get_notification_type_display }}
                        </span>
                        <span class="notification-item-time">{{ notification.created_at|timesince }} ago</span>
                    </div>
                    <h4 class="notification-item-title">{{ notification.title }}</h4>
                    <p class="notification-item-message">{{ notification.message }}</p>
                </a>
                {% endfor %}
            {% else %}
                <div class="notification-dropdown-empty">
                    <i class="fas fa-bell-slash"></i>
                    <p>No notifications</p>
                </div>
            {% endif %}
        </div>
        <div class="notification-footer">
            <a href="/admissions/notifications/">View all notifications</a>
        </div>
    `;
    
    // Add styles for notification dropdown
    const style = document.createElement('style');
    style.textContent = `
        .notification-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            width: 320px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            overflow: hidden;
        }
        
        .notification-header {
            padding: 16px 20px;
            border-bottom: 1px solid #F0F0F0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .notification-header h4 {
            font-size: 16px;
            font-weight: 600;
            color: #453F4E;
        }
        
        .mark-all-read {
            background: none;
            border: none;
            color: #214888;
            font-size: 12px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .notification-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .notification-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            border-bottom: 1px solid #F0F0F0;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .notification-item:hover {
            background-color: #F3EBFF;
        }
        
        .notification-item.unread {
            background-color: #FBF8FF;
            position: relative;
        }
        
        .notification-item.unread::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 6px;
            height: 6px;
            background-color: #214888;
            border-radius: 50%;
        }
        
        .notification-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #F3EBFF;
            color: #214888;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .notification-content p {
            font-size: 14px;
            color: #453F4E;
            margin-bottom: 4px;
        }
        
        .notification-time {
            font-size: 12px;
            color: #453F4E;
            opacity: 0.6;
        }
        
        .notification-footer {
            padding: 12px 20px;
            text-align: center;
            border-top: 1px solid #F0F0F0;
        }
        
        .notification-footer a {
            color: #214888;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
        }
    `;
    
    document.head.appendChild(style);
    
    // Position dropdown
    const notificationLink = document.querySelector('.notification-link');
    const navItem = notificationLink.closest('.nav-item');
    
    navItem.style.position = 'relative';
    navItem.appendChild(notificationDropdown);
    
    // Close dropdown when clicking outside
    setTimeout(() => {
        document.addEventListener('click', function closeNotifications(e) {
            if (!navItem.contains(e.target)) {
                notificationDropdown.remove();
                style.remove();
                document.removeEventListener('click', closeNotifications);
            }
        });
    }, 100);
}
</script>
</body>

</html>